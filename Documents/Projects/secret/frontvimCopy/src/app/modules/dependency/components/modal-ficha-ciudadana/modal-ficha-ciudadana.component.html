<ngx-spinner bdColor="rgba(0,0,0,0.80)"
  size="large"
  color="#fff"
  type="ball-clip-rotate-multiple"
  [fullScreen]="true">
  <p style="font-size: 2rem; color: white !important; margin-top:1rem">Procesando...</p>
</ngx-spinner>
<nz-modal id="request-modal"
  [nzStyle]="{top: '1rem'}"
  nzWidth="85%"
  [nzVisible]="true"
  [nzTitle]="nzTitle"
  (nzOnCancel)="onHideModalClick()"
  (nzOnOk)="onHideModalClick()">
  <ng-container *nzModalContent
    class="ant-modal-body">

    <div class="row">
      <div *ngIf="viewConfigForYear.requisites && nextStepsConfig.validated"
        class="col-md-3 bg-requirement div-requirements">
        <div class="title">
          <h1>Requisitos</h1>
          <h3>{{completed}} de {{totalRequirement}} Cumplidos</h3>
        </div>

        <div class="div-form">
          <form [formGroup]="formRequirements">

            <label class="pointer"
              formArrayName="requirements"
              *ngFor="let requirement of requirementsFormArray.controls; let i = index">
              <input type="checkbox"
                [formControlName]="i"
                (change)="changeCheck($event)">{{requirementsData[i].requisito}}
            </label>

            <button class="btn btn-custom-validate-status ms-3 div-requirements-btn"
              (click)="changeActualApplicationStatus()"
              *ngIf="docsCheked && session.permissionsList.n7_validar_ebd62c4e63"
              [disabled]="!enable_btn_to_validate">Validar</button>
            <div *ngIf="session.permissionsList.n7_enviarObservacion_3dad055cb8a8">
              <button class="btn btn-custom-validate-status ms-3 div-requirements-btn"
                (click)="sendForObservation()"
                *ngIf="!docsCheked"
                [disabled]="!enable_btn_to_comment">Mandar a observación</button>
            </div>
          </form>
        </div>
      </div>
      <div *ngIf="viewConfigForYear.tabs"
        class="col-md-9">
        <nz-tabset nzType="card">
          <nz-tab *ngFor="let tab of tabSet"
            [nzTitle]="tab.title">
            <ng-container *ngIf="tab.id == 'personalData'; then personalData"></ng-container>
            <ng-container *ngIf="tab.id == 'weighing'; then weighing"></ng-container>
            <ng-container *ngIf="tab.id == 'historic'; then historic"></ng-container>
            <ng-container *ngIf="tab.id == 'documents'; then documents"></ng-container>
          </nz-tab>
        </nz-tabset>
      </div>
    </div>

  </ng-container>
  <div *nzModalFooter
    class="">
    <!-- Start flow config -->
    <button class="btn btn-custom-primary ms-3"
      (click)="changeActualApplicationStatus()"
      *ngIf="nextStepsConfig.dictamination && session.permissionsList.n6_dictaminarBtn_3c1297faa940">Dictaminar
      solicitud</button>
    <button class="btn btn-custom-primary ms-3"
      (click)="changeActualApplicationStatus()"
      *ngIf="nextStepsConfig.aproved && session.permissionsList.n6_aprobarBtn_8ffcf15c7a6d">Aprobar solicitud</button>
    <button class="btn btn-custom-primary ms-3"
      (click)="changeActualApplicationStatus()"
      *ngIf="nextStepsConfig.entered && session.permissionsList.n6_entregarBtn_e54f2a6b4930">Entregar solicitud</button>
    <!-- End flow config -->
    <button class="btn btn-custom-warning me-3"
      (click)="interactCancelModal()"
      *ngIf="session.permissionsList.n6_cancelarBtn_9f457ae2d3">Cancelar</button>
    <button class="btn btn-custom-danger me-3"
      (click)="interactRejectModal()"
      *ngIf="session.permissionsList.n6_rechazarBtn_ab047a7e62f3">Rechazar</button>
    <button class="btn btn-vim-outline me-3"
      (click)="onHideModalClick()">Cerrar modal</button>
  </div>
</nz-modal>

<!-- PERSONAL DATA  -->
<ng-template #personalData>
  <div class="row px-5 modal-container">
    <div class="col-sm-12 col-md-6 div-personal-data">
      <p><span>Nombre: </span>{{data.nombreCompleto}}</p>
      <p><span>CURP: </span>{{data.curp}}</p>
      <p><span>Genero: </span>{{data.genero}}</p>
      <p><span>Nacionalidad: </span>{{data.nacionalidad}}</p>
      <p><span>Edad: </span>{{data.edad}} años</p>
      <p><span>Estado civil: </span>{{data.estadoCivil}}</p>
      <p><span>Municipio: </span>{{data.domicilio.municipio.nombre}}</p>
      <p><span>Zona impulso: </span>{{data.domicilio.zonaImpulso.codigo}}</p>
      <p><span>Tiene hijos: </span>{{(data.tieneHijos.respuesta == true) ? ('Si tiene') : ('No tiene') }}</p>
      <p><span>Comunidad indigena: </span>{{(data.comunidadIndigena.respuesta == true)? ('Si pertenece') : ('No pertenece')}}</p>
      <p><span>Habla dialecto: </span>{{(data.hablaDialecto.respuesta == true) ? ('Si habla dialecto') : ('No habla dialecto')}}</p>
      <p><span>Afromexicano: </span>{{(data.afroMexicano == true) ? ('Es afromexicano') : ('No es afromexicano')}}</p>
      <p><span>Migrante: </span>{{(data.migrante.respuesta == true) ? ('Es migrante') : ('No es migrante')}}</p>
    </div>

    <div class="col-sm-12 col-md-6 div-data">
      <div class="row mb-4">
        <div class="col-md-12 d-flex justify-content-center">
          <button class="btn btn-custom-primary ms-3"
            (click)="downloadZip(allDocuments)">Descargar expediente
          </button>
          <button class="btn btn-custom-primary ms-3"
            (click)="downloadSolicitud()">Solicitud Electrónica
          </button>
        </div>
      </div>
      <!-- <p class="download-row" (click)="showPdf(false)"> <i nz-icon nzType="cloud-download" class="icon-download-action" nzTheme="outline"></i> <span></span>Solicitud Impulso</p> -->
      <!-- <p class="download-row" (click)="showPdf()" *ngIf="existsCedula"> <i nz-icon nzType="cloud-download" class="icon-download-action" nzTheme="outline"></i> <span></span>Cédula Impulso</p> -->
      <p *ngFor="let document of allDocuments"
        class="download-row"
        (click)="downloadFile(document)">
        <span class="text-info bw-text">
          <em nz-icon
            nzType="cloud-download"
            class="icon-download-action"
            nzTheme="outline"></em>
        </span>
        {{document.nombre}}
      </p>
    </div>

    <div class="col-sm-12 col-md-6 div-data">
      <div id="map"
        class="map"></div>
      <p>{{data.domicilio.completo}}</p>
    </div>
  </div>
</ng-template>

<!-- WEIGHING  -->
<ng-template #weighing>
  <div class="row mt-2 mb-2 ms-2 me-2 pt-3 ps-3 pe-3 pb-3">
    <div class="col-md-12"
      *ngIf="hasCedula === true">
      <p class="text-center p-modal-text">Vulnerabilidad: <span [outerHTML]="total_weigh | badgeWeighing"></span></p>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">Rubro</th>
            <th scope="col">Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let weigh of weighing_list">
            <th scope="row">{{weigh.title}}</th>
            <td>{{weigh.number}} puntos</td>
          </tr>
          <tr>
            <th scope="row">Total</th>
            <td>{{total_weigh}} puntos</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-6 d-flex justify-content-center"
      *ngIf="hasCedula === false">
      <p class="p-modal-text">No cuenta con cédula</p>
    </div>
  </div>
</ng-template>

<!-- HISTORIC  -->
<ng-template #historic>
  <div class="row">
    <div class="col-md-12">
      <table class="historical-table">
        <thead>
          <tr>
            <th>Apoyo</th>
            <th>Programa</th>
            <th>Ventanilla captura</th>
            <th>Fecha</th>
            <th>Estatus</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of historical_data">
            <td>{{data.programa.modalidad.tipoApoyo.nombre}}</td>
            <td>{{data.programa | showModalityName}}</td>
            <td>{{data.ventanillaCaptura.siglas}} - {{data.ventanillaCaptura.nombre}}</td>
            <td>{{data.fechaCaptura.diaMes}} {{data.fechaCaptura.anio}}</td>
            <td>
              <span [outerHTML]="data.estatusActual.descripcion| statusBadge"></span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <nz-pagination (nzPageIndexChange)="onIndexChange($event)"
        [nzPageSize]="paginator.pagination.pageSize"
        [nzPageIndex]="paginator.pagination.pageIndex"
        [nzTotal]="paginator.pagination.totalRecords">
      </nz-pagination>
    </div>
  </div>
</ng-template>

<!-- DOCUMENTS  -->
<ng-template #documents>
  <div class="row">
    <div class="col-md-12">
      <!-- STANDARD -->
      <ng-container *ngFor="let item of standardDocuments; let i = index">
        <h2>{{ item.nombre }}</h2>
        <!-- <h2>{{standardDocuments[i].nombre}}</h2> -->
        <section class="row">
          <!-- Document viewer  -->
          <div class="col-md-6 selection-box text-center"
            *ngIf="fileExists(solicitudStandardDocuments, item.nombre)">
            <iframe *ngIf="getFileUrl(solicitudStandardDocuments, item.nombre)"
              [src]="getFileUrl(solicitudStandardDocuments, item.nombre) | safe: 'resourceUrl'"
              frameBorder="0"
              scrolling="auto"
              height="80%"
              width="100%"></iframe>
          </div>
          <div class="col-md-6">
            <div class="row">
              <!-- Checkbox  -->
              <div class="col-md-12 px-2 py-2 text-center">
                <p class="text-center">¿Este documento cumple con las caracteristicas necesarias?</p>
                <div class="row">
                  <div class="col-md-12 d-flex justify-content-center">
                    <nz-radio-group nzButtonStyle="solid"
                      class="form-group my-3 d-flex">
                      <label id="selected_radio"
                        nz-radio-button
                        nzValue="'false'"
                        class="multiline-5-radio-button"
                        (click)="onSelectedStatusChange(item,true,'estandar')">Si cumple</label>
                      <label id="unselected_radio"
                        nz-radio-button
                        nzValue="'true'"
                        class="multiline-5-radio-button"
                        (click)="onSelectedStatusChange(item,false,'estandar')">No cumple</label>
                    </nz-radio-group>
                  </div>
                </div>
              </div>
              <div class="col-md-12">
                <nz-form-item>
                  <nz-form-control>
                    <textarea rows="3"
                      nz-input
                      *ngIf="item.check_selected == false"
                      (change)="txtAreaValue($event, item.nombre, 'estandar')"
                      onchange="testing()"
                      placeholder="Escribe tus observaciones"></textarea>
                  </nz-form-control>
                </nz-form-item>
              </div>
            </div>
          </div>
        </section>
        <!-- Historic list  -->
        <div class="row">
          <div class="col-md-12">
            <!-- Not has comments  -->
            <div class="card-container-true">
              <nz-tabset nzType="card"
                *ngIf="!item.observaciones">
                <nz-tab nzTitle="Sin observaciones">
                  <div class="card-container-true-content">
                    <div class="card-container-true-content-comment">
                      <p class="ml-5">Este documento no contiene observaciones</p>
                    </div>
                  </div>
                </nz-tab>
              </nz-tabset>
            </div>
            <!-- Has comments  -->
            <div
              [ngClass]="{'card-container-false': item.habilitado === false,'card-container-true': item.habilitado === true}">
              <nz-tabset nzType="card"
                style="height:220px;"
                [nzTabPosition]="nzTabPosition"
                [(nzSelectedIndex)]="selectedIndex"
                (nzSelectChange)="log([$event])"
                *ngIf="item.observaciones">
                <nz-tab *ngFor="let tab of item.observaciones | reorderObservations; let i = index"
                  nzTitle="Observación # {{i + 1}}"
                  (nzSelect)="log(['select', tab])"
                  (nzClick)="log(['click', tab])"
                  (nzContextmenu)="log(['contextmenu', tab])"
                  (nzDeselect)="log(['deselect', tab])">
                  <div
                    [ngClass]="{'div-historic-list': item.habilitado === false,'div-historic-list-true': item.habilitado === true}">
                    <p class="div-historic-list-usr">{{tab.usuario | formatNameWithoutRol}}</p>
                    <div class="div-historic-list-comment">
                      <p class="ml-5 pb-2">Usuario de campo: {{captureUser}}</p>
                      <p class="ml-5 pb-2">{{tab.comentario}}</p>
                    </div>
                    <span
                      [ngClass]="{'div-historic-list-date': item.habilitado === false,'div-historic-list-true-date': item.habilitado === true}">
                      <em nz-icon
                        nzType="clock-circle"
                        nzTheme="outline"></em>
                      {{tab.fecha | date: 'medium' : 'GMT'}}
                    </span>
                  </div>
                </nz-tab>
              </nz-tabset>
            </div>
          </div>
        </div>
        <hr>
      </ng-container>

      <!--  ESPECIFICOS -->
      <ng-container *ngFor="let item of specificDocuments; let i = index">
        <h2>{{ item.nombre }}</h2>

        <article class="row">
          <section *ngIf="fileExists(solicitudProgramDocuments, item.nombre)"
            class="col-md-6 selection-box text-center">
            <iframe *ngIf="getFileUrl(solicitudProgramDocuments, item.nombre)"
              [src]="getFileUrl(solicitudProgramDocuments, item.nombre) | safe: 'resourceUrl'"
              scrolling="auto"
              height="80%"
              width="100%"></iframe>
          </section>
          <div class="col-md-6">
            <div class="row">
              <!-- Checkbox  -->
              <div class="col-md-12 px-2 py-2 text-center">
                <p class="text-center">¿Este documento cumple con las caracteristicas necesarias?</p>
                <div class="row">
                  <div class="col-md-12 d-flex justify-content-center">
                    <nz-radio-group nzButtonStyle="solid"
                      class="form-group my-3 d-flex">
                      <label nz-radio-button
                        nzValue="'false'"
                        class="multiline-5-radio-button"
                        (click)="onSelectedStatusChange(item,true,'especifico')">Si cumple</label>
                      <label nz-radio-button
                        nzValue="'true'"
                        class="multiline-5-radio-button"
                        (click)="onSelectedStatusChange(item,false,'especifico')">No cumple</label>
                    </nz-radio-group>
                  </div>
                </div>
              </div>
              <div class="col-md-12">
                <nz-form-item>
                  <nz-form-control>
                    <textarea rows="3"
                      nz-input
                      *ngIf="item.check_selected == false"
                      (change)="txtAreaValue($event, item.nombre, 'especifico')"
                      placeholder="Escribe tus observaciones"></textarea>
                  </nz-form-control>
                </nz-form-item>
              </div>
            </div>
          </div>
        </article>
        <!-- Historic list  -->
        <div class="row">
          <div class="col-md-12">
            <!-- Not has comments  -->
            <div class="card-container-true">
              <nz-tabset nzType="card"
                *ngIf="!item.observaciones">
                <nz-tab nzTitle="Sin observaciones">
                  <div class="card-container-true-content">
                    <div class="card-container-true-content-comment">
                      <p class="ml-5">Este documento no contiene observaciones</p>
                    </div>
                  </div>
                </nz-tab>
              </nz-tabset>
            </div>
            <!-- Has comments  -->
            <div
              [ngClass]="{'card-container-false': item.habilitado === false,'card-container-true': item.habilitado === true}">
              <nz-tabset nzType="card"
                style="height:220px;"
                [nzTabPosition]="nzTabPosition"
                [(nzSelectedIndex)]="selectedIndex"
                (nzSelectChange)="log([$event])"
                *ngIf="item.observaciones">
                <nz-tab *ngFor="let tab of item.observaciones; let i = index"
                  nzTitle="Observación # {{i + 1}}"
                  (nzSelect)="log(['select', tab])"
                  (nzClick)="log(['click', tab])"
                  (nzContextmenu)="log(['contextmenu', tab])"
                  (nzDeselect)="log(['deselect', tab])">
                  <div
                    [ngClass]="{'div-historic-list': item.habilitado === false,'div-historic-list-true': item.habilitado === true}">
                    <p class="div-historic-list-usr">{{tab.usuario | formatNameWithoutRol}}</p>
                    <div class="div-historic-list-comment">
                      <p class="ml-5 pb-2">Usuario de campo: {{captureUser}}</p>
                      <p class="ml-5">{{tab.comentario}}</p>
                    </div>
                    <span
                      [ngClass]="{'div-historic-list-date': item.habilitado === false,'div-historic-list-true-date': item.habilitado === true}">
                      <em nz-icon
                        nzType="clock-circle"
                        nzTheme="outline"></em>
                      {{tab.fecha | date: 'medium' : 'GMT'}}
                    </span>
                  </div>
                </nz-tab>
              </nz-tabset>
            </div>
          </div>
        </div>
        <hr>
      </ng-container>
    </div>
  </div>
</ng-template>

<!-- Modal for rejecting application -->
<modal-reject-request [isOpenModal]="show_reject_modal"
  [modalData]="modalData"
  (closeModalEvent)="onApplicationUpdate($event)"></modal-reject-request>
<!-- Modal for cancel application -->
<modal-cancel-request [isOpenModal]="showCancelModal"
  [modalData]="modalData"
  (closeModalEvent)="onApplicationUpdate($event)"></modal-cancel-request>